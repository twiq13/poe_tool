<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Répartition des gains (Fairplay)</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <div class="poe-calc">
    <div class="wrap">
      <div class="header">
        <div>
          <h1>Répartition des gains (mode fairplay)</h1>
          <p class="sub">
            Règle : on rembourse l’investissement de chacun, puis on partage le profit selon les <b>participations</b> (maps jouées).
            <br/>Affichage : <b>Maps total</b> = maps du run (valeur max). <b>Participations</b> = somme des maps (utilisée pour le calcul).
          </p>
        </div>
      </div>

      <div class="panel">
        <div class="topbar">
          <div class="group">
            <div class="chip">
              Gains du groupe :
              <strong><span id="gainsDisplay">6000</span></strong>
              <span class="mini">(div/chaos)</span>
            </div>
            <div class="gains-input">
              <input id="gainsInput" type="number" min="0" step="1" value="6000" />
            </div>
          </div>

          <div class="btns">
            <button id="addRowBtn">+ Ajouter un joueur</button>
            <button class="danger" id="resetBtn">Réinitialiser</button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width: 200px;">Nom du joueur</th>
                <th style="width: 180px;">Maps jouées</th>
                <th style="width: 280px;">Investissement total</th>
                <th style="width: 240px;">Invest / map</th>
                <th style="width: 200px;">Gains</th>
                <th style="width: 80px;"></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="status">
          <div class="status-col">
            <span class="pill" id="playersPill">Joueurs: 0</span>
            <span class="pill" id="invPill">Invest total: 0</span>
            <span class="pill" id="mapsPill">Maps total: 0</span>
            <span class="pill" id="partsPill">Participations: 0</span>
            <span class="pill" id="profitPill">Profit: 0</span>
          </div>
          <div class="status-col">
            <span class="pill" id="modePill">Mode: —</span>
            <span class="pill" id="checkPill">Somme gains: 0</span>
          </div>
        </div>
      </div>

      <div class="help">
        Modèle :
        <span class="mono">gain = inv + (gains - totalInv) * (maps / sommeParticipations)</span>
        <br/>
        Si <span class="mono">gains &lt; totalInv</span> : répartition au prorata de l’investissement.
      </div>
    </div>
  </div>

  <script>
    // -----------------------
    // Format / utils (0 décimale)
    // -----------------------
    const fmtInt = new Intl.NumberFormat("fr-FR", { maximumFractionDigits: 0, minimumFractionDigits: 0 });

    const toNum = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const roundInt = (n) => Math.round(n);

    // -----------------------
    // Data (✅ 1 seule ligne au départ)
    // -----------------------
    const defaultRows = [
      { name: "Joueur 1", maps: 0, inv: 0 }
    ];
    let rows = structuredClone(defaultRows);

    // -----------------------
    // DOM
    // -----------------------
    const tbody = document.getElementById("tbody");
    const gainsInput = document.getElementById("gainsInput");
    const gainsDisplay = document.getElementById("gainsDisplay");

    const playersPill = document.getElementById("playersPill");
    const invPill = document.getElementById("invPill");
    const mapsPill = document.getElementById("mapsPill");     // MAX maps (run)
    const partsPill = document.getElementById("partsPill");   // SUM maps (participations)
    const profitPill = document.getElementById("profitPill");
    const modePill = document.getElementById("modePill");
    const checkPill = document.getElementById("checkPill");

    document.getElementById("addRowBtn").addEventListener("click", () => {
      rows.push({ name: `Joueur ${rows.length + 1}`, maps: 0, inv: 0 });
      render();
      recalc();
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      rows = structuredClone(defaultRows);
      gainsInput.value = 6000;
      render();
      recalc();
    });

    gainsInput.addEventListener("input", () => {
      gainsDisplay.textContent = fmtInt.format(toNum(gainsInput.value));
      recalc();
    });

    // -----------------------
    // Render
    // -----------------------
    function render() {
      tbody.innerHTML = "";

      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");

        // Name
        const tdName = document.createElement("td");
        const inName = document.createElement("input");
        inName.type = "text";
        inName.value = r.name ?? "";
        inName.placeholder = "Nom…";
        inName.addEventListener("input", (e) => {
          rows[idx].name = e.target.value;
          recalc();
        });
        tdName.appendChild(inName);

        // Maps
        const tdMaps = document.createElement("td");
        const inMaps = document.createElement("input");
        inMaps.type = "number";
        inMaps.min = "0";
        inMaps.step = "1";
        inMaps.value = r.maps ?? 0;
        inMaps.addEventListener("input", (e) => {
          rows[idx].maps = toNum(e.target.value);
          recalc();
        });
        tdMaps.appendChild(inMaps);

        // Invest
        const tdInv = document.createElement("td");
        const inInv = document.createElement("input");
        inInv.type = "number";
        inInv.min = "0";
        inInv.step = "1";
        inInv.value = r.inv ?? 0;
        inInv.addEventListener("input", (e) => {
          rows[idx].inv = toNum(e.target.value);
          recalc();
        });
        tdInv.appendChild(inInv);

        // Invest/map (computed)
        const tdInvMap = document.createElement("td");
        tdInvMap.className = "num muted";
        tdInvMap.dataset.role = "invMap";
        tdInvMap.textContent = "—";

        // Gain (computed)
        const tdGain = document.createElement("td");
        tdGain.className = "num gain";
        tdGain.dataset.role = "gain";
        tdGain.textContent = "—";

        // Actions
        const tdAct = document.createElement("td");
        const actions = document.createElement("div");
        actions.className = "row-actions";
        const del = document.createElement("button");
        del.className = "danger";
        del.textContent = "✕";
        del.title = "Supprimer";
        del.addEventListener("click", () => {
          rows.splice(idx, 1);
          render();
          recalc();
        });
        actions.appendChild(del);
        tdAct.appendChild(actions);

        tr.appendChild(tdName);
        tr.appendChild(tdMaps);
        tr.appendChild(tdInv);
        tr.appendChild(tdInvMap);
        tr.appendChild(tdGain);
        tr.appendChild(tdAct);

        tbody.appendChild(tr);
      });
    }

    // -----------------------
    // Calc (Fairplay)
    // -----------------------
    function recalc() {
      const totalGains = toNum(gainsInput.value);
      gainsDisplay.textContent = fmtInt.format(totalGains);

      // Active rows = has name OR any non-zero number
      const active = rows
        .map((r, i) => ({ ...r, i }))
        .filter(r => (String(r.name || "").trim() !== "") || toNum(r.maps) > 0 || toNum(r.inv) > 0);

      const totalInv = active.reduce((s, r) => s + toNum(r.inv), 0);

      // ✅ Display needs MAX (maps du run), calc needs SUM (participations)
      const mapsMax = active.reduce((m, r) => Math.max(m, toNum(r.maps)), 0);
      const mapsSum = active.reduce((s, r) => s + toNum(r.maps), 0);

      const enoughToRefund = totalGains >= totalInv;
      const profit = totalGains - totalInv;

      playersPill.textContent = `Joueurs: ${active.length}`;
      invPill.textContent = `Invest total: ${fmtInt.format(roundInt(totalInv))}`;
      mapsPill.textContent = `Maps total: ${fmtInt.format(mapsMax)}`;
      partsPill.textContent = `Participations: ${fmtInt.format(mapsSum)}`;
      profitPill.textContent = `Profit: ${fmtInt.format(roundInt(profit))}`;

      profitPill.className = "pill " + (profit >= 0 ? "good" : "bad");
      modePill.className = "pill " + (enoughToRefund ? "good" : "warn");
      modePill.textContent = enoughToRefund
        ? "Mode: remboursement + profit/participations"
        : "Mode: gains < investissement (prorata inv)";

      // Compute
      const computed = new Map();

      active.forEach(r => {
        const maps = toNum(r.maps);
        const inv = toNum(r.inv);

        const invPerMap = maps > 0 ? inv / maps : 0;

        let gain = 0;
        if (!active.length || totalGains === 0) {
          gain = 0;
        } else if (!enoughToRefund) {
          // prorata investissement si pas assez
          gain = totalInv > 0 ? totalGains * (inv / totalInv) : 0;
        } else {
          // remboursement + profit au prorata des participations
          const share = mapsSum > 0 ? profit * (maps / mapsSum) : 0;
          gain = inv + share;
        }

        computed.set(r.i, {
          invPerMap: roundInt(invPerMap),
          gain: roundInt(gain),
        });
      });

      // Paint
      let sumShown = 0;
      [...tbody.querySelectorAll("tr")].forEach((tr, idx) => {
        const invMapCell = tr.querySelector('[data-role="invMap"]');
        const gainCell = tr.querySelector('[data-role="gain"]');
        const data = computed.get(idx);

        if (!data) {
          invMapCell.textContent = "—";
          gainCell.textContent = "—";
          return;
        }

        invMapCell.textContent = fmtInt.format(data.invPerMap);
        gainCell.textContent = fmtInt.format(data.gain);
        sumShown += data.gain;
      });

      checkPill.textContent = `Somme gains: ${fmtInt.format(roundInt(sumShown))}`;
      const diff = Math.abs(sumShown - totalGains);
      checkPill.className = "pill " + (diff <= 1 ? "good" : "warn"); // tolérance 1 car arrondis
    }

    // Init
    render();
    recalc();
  </script>
</body>
</html>
